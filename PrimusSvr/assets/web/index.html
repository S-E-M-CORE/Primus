<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Management Dashboard</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
</head>

<body>
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header">
                        <h2>Upcoming Birthdays</h2>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive"> <!-- Bootstrap class for responsive tables -->
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>Name</th>
                                        <th>Date</th>
                                    </tr>
                                </thead>
                                <tbody id="upcoming-birthdays">
                                    <!-- Upcoming birthdays will be dynamically added here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header">
                        <h2>Quick Links</h2>
                    </div>
                    <div class="card-body">
                        <ul class="list-group">
                            <li class="list-group-item"><a href="profile_create.html">Add New Member</a></li>
                            <li class="list-group-item"><a href="overview.html">View All Members</a></li>
                        </ul>
                    </div>
                </div>
                <div class="card mt-4">
                    <div class="card-header">
                        <h2>Member Counts</h2>
                    </div>
                    <div class="card-body">
                        <ul class="list-group">
                            <li class="list-group-item member-count" id="active-members">Active Members: Loading...</li>
                            <li class="list-group-item member-count" id="total-members">Total Members: Loading...</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="container mt-5">
        <div class="card">
            <div class="card-header">
                <h2>Members with Most Trainings</h2>
            </div>
            <div class="card-body">
                <table class="table">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Trainings Count</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="most-trainings">
                        <!-- Members with most trainings will be dynamically added here -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // Fetch upcoming birthdays
            fetch('http://localhost:8000/api/v1/members/list/birthday?limit=7&offset=0')
                .then(response => response.json())
                .then(data => {
                    console.log('Received birthday data:', data);
                    const upcomingBirthdaysList = document.getElementById('upcoming-birthdays');
                    if (data.items) {
                        data.items.forEach(member => {
                            upcomingBirthdaysList.innerHTML += '<tr><td>' + member.firstName + ' ' + member.lastName + '</td><td>' + new Date(member.birthDate).toLocaleDateString('de-DE', { day: '2-digit', month: '2-digit', year: 'numeric' }).replace(/-/g, '.') + '</td></tr>';
                        });
                    } else {
                        console.error('No items field found in the birthday response data');
                    }
                })
                .catch(error => {
                    console.error('Error fetching upcoming birthdays:', error);
                });

            // Fetch member counts
            fetch('http://localhost:8000/api/v1/members/count/active')
                .then(response => response.json())
                .then(data => {
                    console.log('Received active members count:', data);
                    const activeMembersCount = document.getElementById('active-members');
                    activeMembersCount.textContent = 'Active Members: ' + data.value;
                })
                .catch(error => {
                    console.error('Error fetching active members count:', error);
                });

            fetch('http://localhost:8000/api/v1/members/count/all')
                .then(response => response.json())
                .then(data => {
                    console.log('Received total members count:', data);
                    const totalMembersCount = document.getElementById('total-members');
                    totalMembersCount.textContent = 'Total Members: ' + data.value;
                })
                .catch(error => {
                    console.error('Error fetching total members count:', error);
                });

            // Fetch members with most trainings
            fetch('http://localhost:8000/api/v1/members/list/attendance?limit=10&offset=0')
                .then(response => response.json())
                .then(data => {
                    console.log('Received most trainings data:', data);
                    const mostTrainingsTable = document.getElementById('most-trainings');
                    if (data.items) {
                        data.items.forEach(member => {
                            fetch('http://localhost:8000/api/v1/member/' + member.id + '/count/attendances')
                                .then(response => response.json())
                                .then(trainingsData => {
                                    console.log('Received trainings count data for member ' + member.id + ':', trainingsData);
                                    const row = document.createElement('tr');
                                    row.innerHTML = `
                                        <td>${member.firstName} ${member.lastName}</td>
                                        <td>${trainingsData.value}</td>
                                        <td><button class="btn btn-primary btn-mark-present" data-id="${member.id}">Mark Present</button></td>
                                    `;
                                    row.querySelector('.btn-mark-present').addEventListener('click', function () {
                                        markPresent(member.id);
                                    });
                                    mostTrainingsTable.appendChild(row);
                                })
                                .catch(error => {
                                    console.error('Error fetching trainings count for member ' + member.id + ':', error);
                                });
                        });
                    } else {
                        console.error('No items field found in the most trainings response data');
                    }
                })
                .catch(error => {
                    console.error('Error fetching members with most trainings:', error);
                });

            // Function to mark member present for today
            function markPresent(memberId) {
                const today = new Date().toISOString().split('T')[0];
                const memberIdString = memberId.toString();
                fetch('http://localhost:8000/api/v1/member/' + memberIdString + '/attendance/' + today, {
                    method: 'POST'
                })
                    .then(response => response.json())
                    .then(data => {
                        console.log('Attendance marked for member:', memberId);
                        alert('Attendance marked successfully for today!');
                    })
                    .catch(error => {
                        console.error('Error marking attendance for member:', memberId, error);
                        alert('Failed to mark attendance for today. Please try again later.');
                    });
            }
        });
    </script>
</body>

</html>
